1.4.2 进行简单的增删改查
===

你刚刚安装完成的MongoDB其中包括两个常用的软件。如果你使用默认目录安装，可以打开`C:\Program Files\MongoDB\Server\[Version]\bin`进行查看，其中的[Version]代表的是你的大版本号，4.0.x都统一记作4.0，同理3.0.x统一记作3.0。

C:\Program Files\MongoDB\Server\[Version]
    - \bin
      - mongo.exe    # MongoDB的命令行工具，可以用来连接和管理MongoDB服务器(不仅限于本地)。
      - mongod.exe   # MongoDB服务器主程序，用来响应所有客户端的连接和请求，并对数据库文件进行操作。
      ...
    ...

使用在`/bin`目录下使用控制台，键入`mongo`，他就会尝试连接本地的27017(MongoDB服务的默认端口号)，如果你的服务器正常启动，那么就可以看到如下的情况：

![1.4.1 Mongo连接成功](img\1.4.1Mongo连接成功.jpg)

接下来我们就可以进行各种操作了。

**提示：** 启动Mongo之后，你实际上到了Mongo自带的JS解释器环境，在这里你可以使用各种JS语言的特性。并且支持命令的Tab补全，命令只要输入一部分，点击Tab键就可以补全，如果没有效果就点两下，会列出所有可能的组合。

# 显示所有的数据库

没有任何内容的数据库不会显示，下面的数据库都是MongoDB的自身配置，建议不要随意更改。

    > show dbs
    admin   0.000GB
    config  0.000GB
    local   0.000GB

# 显示当前数据库
  
    > db
    test

# 切换/新建数据库
  
如果数据库不存在则新建

    > use test                   # 切换数据库
    switched to db test
    > use learnMongodb           # 新建一个叫做`learnMongodb`的数据库
    switched to db learnMongodb
    > db
    learnMongodb

# 创建集合
  
    > db.createCollection("HelloWorld")
    { "ok" : 1 }

# 查询所有的集合
  
    > show collections
    HelloWorld

# 在集合中插入一个文档

    > db.HelloWorld.insert({Hello: "world!"})
    WriteResult({ "nInserted" : 1 })

当然你也可以在不创建集合的情况下直接创建文档，这会根据你的方式自动生成你要的文档。

    > db.areYouOK.insert({ILove: "BUPT", and: "SICE"})
    WriteResult({ "nInserted" : 1 })

# 查询当前集合下所有文档
    
    > db.HelloWorld.find()
    { "_id" : ObjectId("5c88e87ef1deddeb125f7a16"), "Hello" : "world!" }
    > db.areYouOK.find()
    { "_id" : ObjectId("5c88e966f1deddeb125f7a17"), "ILove" : "BUPT", "and" : "SICE" }

# 此时请各位随意插入一些数据进行练习。比如我们建立一个简单的通讯录(mailList)

| name | gender | age |    email    |
|:----:|:------:|:---:|:-----------:|
| Bob  |  Male  | 18  |bob@sinla.com|
| Lili | Female | 20  |lili@jojo.org|
| Tom  |  Male  | 16  |tom@sinla.com|
|Jerry |  Male  | 15  |jerr@bupt.com|
|Jenny | Female | 16  |jenn@bupt.com|

当然你可以选择一条一条插入如下：

    > db.mailList.insert({name:"Bob", gender:"Male", age: 18 ,email:"bob@sinla.com" })
    > db.mailList.insert({name:"Lili", gender:"Female", age: 20 ,email:"lili@jojo.org" })
    > db.mailList.insert({name:"Tom", gender:"Male", age: 16 ,email:"tom@sinla.com" })
    > db.mailList.insert({name:"Jerry", gender:"Male", age: 15 ,email:"jerr@bupt.com" })
    > db.mailList.insert({name:"Jenny", gender:"Female", age: 16 ,email:"jenn@bupt.com" })

当然你也可以选择构建一个数组一下子全插入

    > db.mailList.insert([{name:"Bob", gender:"Male", age: 18 ,email:"bob@sinla.com" },
    ...{name:"Lili", gender:"Female", age: 20 ,email:"lili@jojo.org" },
    ...{name:"Tom", gender:"Male", age: 16 ,email:"tom@sinla.com" },
    ...{name:"Jerry", gender:"Male", age: 15 ,email:"jerr@bupt.com" },
    ...{name:"Jenny", gender:"Female", age: 16 ,email:"jenn@bupt.com" }])
    BulkWriteResult({
            "writeErrors" : [ ],
            "writeConcernErrors" : [ ],
            "nInserted" : 5,
            "nUpserted" : 0,
            "nMatched" : 0,
            "nModified" : 0,
            "nRemoved" : 0,
            "upserted" : [ ]
    })

还有更简单的方法，运用你的JS知识就可以了，在此不一一列举，请各位自行探索。

之后我们再次查询全部就可以看到所有我们插入的数据了。

    > db.mailList.find()
    { "_id" : ObjectId("5c88edbef1deddeb125f7a1f"), "name" : "Bob", "gender" : "Male", "age" : 18, "email" : "bob@sinla.com" }
    .... 这里省略几个人 -- 作者注
    { "_id" : ObjectId("5c88edbef1deddeb125f7a23"), "name" : "Jenny", "gender" : "Female", "age" : 16, "email" : "jenn@bupt.com" }

# 查询 -- 格式化输出

    > db.mailList.find().pretty()
    {
            "_id" : ObjectId("5c88edbef1deddeb125f7a1f"),
            "name" : "Bob",
            "gender" : "Male",
            "age" : 18,
            "email" : "bob@sinla.com"
    }
    .... 这里省略几个人 -- 作者注
    {
            "_id" : ObjectId("5c88edbef1deddeb125f7a23"),
            "name" : "Jenny",
            "gender" : "Female",
            "age" : 16,
            "email" : "jenn@bupt.com"
    }

是不是就好看多了

# 查询 -- 指定条件进行查询

    db.collection.find(query, projection)

- query ：可选，使用查询操作符指定查询条件
- projection ：可选，使用投影操作符指定返回的键。查询时返回文档中所有键值， 只需省略该参数即可（默认省略）。

| 通常的操作 | 语法 | 实例 |
| :-: | :-: | - |
| Equality<br>相等 | `{<key>:<value>}` 或 <br>`{<key>:{$eq:<value>}}` | `> db.mailList.find({name: "Bob"}).pretty()`<br>`{`<br>`"_id" : ObjectId("5c88edbef1deddeb125f7a1f")`<br>`"name" : "Bob",`<br>`"gender" : "Male",`<br>`"age" : 18,`<br>`"email" : "bob@sinla.com"`<br>`}`|
|Less Than<br>小于 | `{<key>:{$lt:<value>}}` | `> db.mailList.find({age:{$lt:16}}).pretty()`<br>`{`<br>`"_id" : ObjectId("5c88edbef1deddeb125f7a22")`<br>`"name" : "Jerry",`<br>`"gender" : "Male",`<br>`"age" : 15,`<br>`"email" : "jerr@bupt.com"`<br>`}`<br> |
|Less Than Equals<br>小于等于|`{<key>:{$lte:<value>}}`| `> db.mailList.find({age:{$lte:15}}).pretty()`<br>结果同上|
|Greater Than<br>大于| `{<key>:{$gt:<value>}}`|`> db.mailList.find({age:{$gt:20}}).pretty()`<br>没有返回值，因为没有符合条件的|
|Greater Than Equals<br>大于等于|`{<key>:{$gte:<value>}}`|`db.mailList.find({age:{$gte:20}}).pretty()`<br>请自行尝试，下同|
|Not Equals<br>不等于| `{<key>:{$ne:<value>}}`|`db.mailList.find({age:{$ne:18}}).pretty()`|

更多查询方式请见 [Query and Projection Operators — MongoDB Manual](https://docs.mongodb.com/manual/reference/operator/query/)


打印一个人名单

    > db.mailList.find({},{name: 1, _id: 0}))
        { "name" : "Bob" }
        { "name" : "Lili" }
        { "name" : "Tom" }
        { "name" : "Jerry" }
        { "name" : "Jenny" }

# 更新

假如Bob改名字了，现在他叫William

    > db.mailList.update({name: "Bob"},{$set:{name: "William"}})
    WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
    > db.mailList.find({name: "William"}).pretty()
    {
            "_id" : ObjectId("5c88edbef1deddeb125f7a1f"),
            "name" : "William",
            "gender" : "Male",
            "age" : 18,
            "email" : "bob@sinla.com"
    }

新年过了，所有人的年龄都大了一岁

    > db.mailList.update({},{$inc:{age: 1}},false,true)
    WriteResult({ "nMatched" : 5, "nUpserted" : 0, "nModified" : 5 })
    > db.mailList.find()
    { "_id" : ObjectId("5c88edbef1deddeb125f7a1f"), "name" : "William", "gender" : "Male", "age" : 19, "email" : "bob@sinla.com" }
    { "_id" : ObjectId("5c88edbef1deddeb125f7a20"), "name" : "Lili", "gender" : "Female", "age" : 21, "email" : "lili@jojo.org" }
    { "_id" : ObjectId("5c88edbef1deddeb125f7a21"), "name" : "Tom", "gender" : "Male", "age" : 17, "email" : "tom@sinla.com" }
    { "_id" : ObjectId("5c88edbef1deddeb125f7a22"), "name" : "Jerry", "gender" : "Male", "age" : 16, "email" : "jerr@bupt.com" }
    { "_id" : ObjectId("5c88edbef1deddeb125f7a23"), "name" : "Jenny", "gender" : "Female", "age" : 17, "email" : "jenn@bupt.com" }

可以看到所有人的岁数都加一了。

    db.collection.update(
        <query>,
        <update>,
        {
            upsert: <boolean>,
            multi: <boolean>,
            writeConcern: <document>
        }
    )

- query : update的查询条件，类似sql update查询内where后面的。
- update : update的对象和一些更新的操作符（如$,$inc[...](https://docs.mongodb.com/manual/reference/operator/update/)）等，也可以理解为sql update查询内set后面的
- upsert : 可选，这个参数的意思是，如果不存在update的记录，是否插入objNew,true为插入，默认是false，不插入。
- multi : 可选，mongodb 默认是false,只更新找到的第一条记录，如果这个参数为true,就把按条件查出来多条记录全部更新。
- writeConcern :可选，抛出异常的级别。

由此可知，所有人的年龄都+1的方式也可以写成`db.mailList.update({},{$inc:{age: 1}},{multi:true})`

# 删除

    db.collection.remove(
        <query>,
        {
            justOne: <boolean>,
            writeConcern: <document>
        }
    )

- query :（可选）删除的文档的条件。
- justOne : （可选）如果设为 true 或 1，则只删除一个文档，如果不设置该参数，或使用默认值 false，则删除所有匹配条件的文档。
- writeConcern :（可选）抛出异常的级别。

William由于某种原因，不能再取得联系了。

    > db.mailList.remove({name: "William"})
    WriteResult({ "nRemoved" : 1 })
    > db.mailList.find().length()
    4

所有人都联系不上了。。。

    > db.mailList.remove()
    2019-03-13T20:24:00.307+0800 E QUERY    [js] Error: remove needs a query :
    DBCollection.prototype._parseRemove@src/mongo/shell/collection.js:362:1
    DBCollection.prototype.remove@src/mongo/shell/collection.js:389:18
    @(shell):1:1
    > db.mailList.remove({})
    WriteResult({ "nRemoved" : 4 })

# 排序

先回到上面添加的步骤，把人都加回来。

    > db.mailList.find({},{name: 1,age: 1 , _id: 0}).sort({age: 1})
    { "name" : "Jerry", "age" : 15 }
    { "name" : "Tom", "age" : 16 }
    { "name" : "Jenny", "age" : 16 }
    { "name" : "Bob", "age" : 18 }
    { "name" : "Lili", "age" : 20 }

现在就是按照年龄升序排列了。
