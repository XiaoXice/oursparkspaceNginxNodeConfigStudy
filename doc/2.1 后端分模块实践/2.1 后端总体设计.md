2.1 后端整体设计
===

“分层设计”是任何程序在开始开发之前要做的事情，没有经过分层设计的程序到最后基本都是不可维护的。这一节我们就将所需要的后台分割成几个小模块，加个大问题分解成小问题。

## 我们需要干什么？

按照需求导向型，我们需要知道自己写的代码需要干什么？

### 接口设计

毫无疑问，作为微信小程序的后台，它要做的最重要的事情就是完成前端提交的各种请求，前端和后端之间的沟通使用则是HTTP协议，很显然，后端提供的服务有很多，并不是一个接口可以解决的，区分不同接口的则是`URL`Uniform Resource Locator，统一资源定位符，也就是我们常说的网址或者路径。不同的路径指向不同的网页/资源/接口，相同的路径则指向相同的东西。URL通常是使用`/`作为分隔符，一级一级的结构。

现在轮到我们自己来定义自己接口的URL，这时候我们就需要**接口设计**。

作为一个前后端分离的程序，常见的后端API设计是采用`RESTful`接口设计风格。

REST，即Representational State Transfer的缩写。

我们总结一下什么是RESTful架构：

1. 每一个URI代表一种资源；
2. 客户端和服务器之间，传递这种资源的某种表现层；
3. 客户端通过四个HTTP动词，对服务器端资源进行操作，实现"表现层状态转化"。

具体的规则可以参考这个网页[restful接口设计规范总结](https://www.jianshu.com/p/8b769356ee67)

回顾一下第一章的内容，我们的资源有下面几个：

1. 用户
2. 留言
3. 留言的评论

我们需要的功能有：

1. 用户的登录和状态检查
2. 留言的创建和获取
3. 评论的创建和获取
4. 喜欢的点赞和获取

因此对应接口的列表也就可以可以出现了

* POST /login 使用微信接口登录
* GET /login 获取现在登陆状态是否有效
* GET /user/:id 获取该用户相关信息
* POST /message 创建一个新的留言
* GET /message 获取留言列表
* DELETE /message/:id 删除一个留言
* PATCH /message/:id 更新留言内容
* GET /message/:id/comment 获取某个留言的评论列表
* POST /message/:id/comment 提交一个评论
* GET /message/:id/comment/:id 获取某个留言的评论的相关信息
* DELETE /message/:id/comment/:id 删除一个评论
* PATCH /message/:id/comment/:id 更新评论内容
* POST /message/:id/like 给留言喜欢
* DELETE /message/:id/like 取消留言的喜欢

然后就是给每个接口调用需要传递的参数进行规定，这方面的事情应该就可以水到渠成了。等我们具体的进行接口实现的时候在加考虑，如果你认为自己独立设计这么一套接口有些困难，这是正常现象，毕竟很多人都是第一次考虑这么后端的事情，平时在网页上点点点，应该也不会注意背后的运行机制，有兴趣的同学可以去Github的API列表学习一下它的设计思路，平时在使用网站/APP/微信小程序的时候也可以把自己当作设计师，想一下如果是让我们自己设计，应该如何设计。

### 数据库结构设计

再次回顾我们的资源：

1. 用户
2. 留言
3. 留言的评论

根据MongoDB的NoSQL特性，我们这样设计三个集合和他们的结构：

- user

    ``` JS
    {
        _id: ObjectID,            // MongoDB自动生成的唯一标识
        openID: String,           // 微信小程序的统一用户ID
        sessionKey: String,       // 用来和 微信小程序校验信息的 东西
        nickName: String,         // 用户昵称
        avatarUrl: String,        // 用户头像地址
        messgaeList: [ObjectID],  // 这个用户的所有留言的_id组成的数组
        commitLIst: [ObjectID],   // 这个用户所有评论_id组成的数组
    }
    ```
- message

    ``` JS
    {
        _id: ObjectID,            // MongoDB 自动生成的唯一标识
        author: ObjectID,         // 这篇留言的作者
        content: String,          // 这篇留言的内容
        like: [ObjectID],         // 点赞的人
        commitList: [ObjectID],   // 评论列表
        creationTime: Date,       // 创建时间
        updateTime: Date          // 更新时间
    }
    ```

- commit

    ``` JS
    {
        _id: ObjectID,            // MongoDB 自动生成的统一ID
        author: ObjectID,         // 这篇评论的作者
        message: ObjectID,        // 这篇评论所处的留言
        content: String,          // 这篇评论的内容
        followList: [ObjectID]    // 回复这篇评论的评论
    }
    ```

到此为止，我们后端的总体设计就完成了，下面我们就开始构建我们的后端程序。